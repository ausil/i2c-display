name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            suffix: linux-armv7
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history including tags for version detection

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          make build
          mv bin/i2c-displayd bin/i2c-displayd-${{ matrix.suffix }}

      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: i2c-displayd-${{ matrix.suffix }}
          path: bin/i2c-displayd-${{ matrix.suffix }}

  build-tarball:
    name: Build source tarball
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Build source tarball
        run: make dist

      - name: Upload tarball
        uses: actions/upload-artifact@v6
        with:
          name: source-tarball
          path: dist/*.tar.gz

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-tarball]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v6

      - name: Generate changelog
        id: changelog
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract changelog entries for this version from the RPM spec
          CHANGELOG=$(sed -n "/^%changelog/,\$p" rpm/i2c-display.spec \
            | sed '1d' \
            | sed "/^$/q" \
            | grep "^-" \
            | sed 's/^/  /')

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.changelog.outputs.version }}
          body: |
            # I2C Display Controller v${{ steps.changelog.outputs.version }}

            ## Changes
            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ### Binary downloads

            - `i2c-displayd-linux-arm64` - ARM64 (Raspberry Pi 4/5, Rock 3C/5B)
            - `i2c-displayd-linux-armv7` - ARMv7 (Raspberry Pi 2/3)
            - `i2c-displayd-linux-amd64` - x86_64

            ### Building packages locally

            ```bash
            # Fedora/RHEL
            sudo dnf install -y git golang rpm-build systemd-rpm-macros
            git clone https://github.com/ausil/i2c-display.git
            cd i2c-display
            make rpm
            sudo dnf install rpm-build/RPMS/*/i2c-display-*.rpm

            # Debian/Ubuntu/Raspberry Pi OS
            sudo apt-get install -y git golang debhelper devscripts dh-golang
            git clone https://github.com/ausil/i2c-display.git
            cd i2c-display
            make deb
            sudo apt install ../i2c-display_*.deb
            ```

            See [README.md](https://github.com/ausil/i2c-display/blob/main/README.md) for complete installation instructions.
          files: |
            i2c-displayd-linux-*/i2c-displayd-*
            source-tarball/*.tar.gz
          draft: false
          prerelease: false
